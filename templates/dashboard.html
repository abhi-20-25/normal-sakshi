<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakshi.AI - Dashboard</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #0D1117; --bg-secondary: #161B22; --border-color: #30363D; --text-primary: #C9D1D9; --text-secondary: #8B949E; --accent-color: #238636; --accent-hover: #2ea043; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-primary); color: var(--text-primary); }
        .glass-nav { background: rgba(13, 17, 23, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .header { padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; }
        .header-logo { display: flex; align-items: center; gap: 12px; }
        .header h1 { margin: 0; font-size: 1.5em; font-weight: 700; color: #fff; }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .app-section { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; }
        .app-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .app-header h2 { margin: 0; font-size: 1.2em; }
        .app-header .status { font-size: 0.9em; color: var(--text-secondary); }
        .app-header .status .online-dot { display: inline-block; width: 8px; height: 8px; background-color: var(--accent-color); border-radius: 50%; margin-right: 6px; }
        .app-content { padding: 20px; }
        .btn { padding: 8px 16px; cursor: pointer; border: 1px solid var(--border-color); background-color: #21262d; color: var(--text-primary); border-radius: 6px; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--border-color); }
        .btn-primary { background-color: var(--accent-color); border-color: var(--accent-color); color: #fff; text-decoration: none; }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; min-height: 200px; }
        .history-item { border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; background-color: var(--bg-primary); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .history-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .history-item img { width: 100%; aspect-ratio: 4/3; object-fit: cover; background: #000; }
        .history-item-info { padding: 10px; font-size: 0.8em; }
        .history-item-info p { margin: 0 0 5px 0; color: var(--text-secondary); }
        .history-item-info strong { color: var(--text-primary); }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { padding: 8px 16px; margin: 0 5px; cursor: pointer; border: 1px solid var(--border-color); background-color: #21262d; color: var(--text-primary); border-radius: 6px; }
        .pagination button:disabled { cursor: not-allowed; opacity: 0.5; }
        .layout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stream-box { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; max-width: 100%; position: relative; }
        .stream-box img { width: 100%; display: block; background-color: #000; }
        .stream-header, .stream-footer { padding: 10px; background-color: var(--bg-primary); font-weight: bold; }
        .stream-header { font-size: 0.9em; text-align: left; }
        .stream-footer { font-size: 1.1em; text-align: center; }
        .report-section { flex-grow: 1; min-width: 300px; }
        .report-section input[type="date"] { background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; border-radius: 4px; }
        .report-section table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-section th, .report-section td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 0.9em; }
        .report-section th { background-color: #21262d; }
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .tab-button { padding: 10px 15px; cursor: pointer; background: transparent; color: var(--text-secondary); border: none; border-bottom: 3px solid transparent; font-size: 0.9em; }
        .tab-button.active { border-bottom: 3px solid var(--accent-color); font-weight: bold; color: var(--text-primary); }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-secondary); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 900px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-btn { color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer; }
        .report-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card { background-color: var(--bg-primary); padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); }
        .summary-card h4 { margin: 0 0 5px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 500; }
        .summary-card p { margin: 0; font-size: 1.5em; font-weight: 600; }
        .lightbox { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .lightbox-close { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .lightbox-close:hover { color: var(--accent-color); }
        .filter-controls { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background-color: var(--bg-primary); border-radius: 6px; }
        .roi-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }
        .roi-controls { display: none; gap: 10px; align-items: center; margin-top: 10px; }
        .roi-controls.active { display: flex; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .layout-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="antialiased">

<header class="glass-nav sticky top-0 z-50">
    <div class="header max-w-[1400px] mx-auto">
        <div class="header-logo">
            <svg style="width: 2rem; height: 2rem; color: var(--accent-color);" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 18.5C8.97 18.5 6.5 16.03 6.5 13H8.5C8.5 14.93 10.07 16.5 12 16.5C13.93 16.5 15.5 14.93 15.5 13C15.5 11.07 13.93 9.5 12 9.5C10.07 9.5 8.5 11.07 8.5 13H6.5C6.5 9.97 8.97 7.5 12 7.5C15.03 7.5 17.5 9.97 17.5 13C17.5 16.03 15.03 18.5 12 18.5Z" fill="currentColor"/></svg>
            <h1>Sakshi<span style="color: var(--accent-color);">.AI</span> Dashboard</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/" style="color: var(--text-secondary); font-size: 0.9em; text-decoration: none;">&larr; Back to Landing Page</a>
            <a href="/logout" style="background: #dc3545; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9em; transition: background 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">Logout</a>
        </div>
    </div>
</header>

<div class="container" id="dashboard-container"></div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="reportModalTitle">Footfall Analysis Report</h2>
            <span class="close-btn" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="report-controls">
            <span>Period:</span>
            <button class="btn" onclick="generateReport('7days')">Last 7 Days</button>
            <button class="btn" onclick="generateReport('30days')">Last 30 Days</button>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <span>Chart Type:</span>
                <button class="btn" id="barChartBtn" onclick="renderChart('bar')">Bar</button>
                <button class="btn" id="lineChartBtn" onclick="renderChart('line')">Line</button>
                <a id="downloadCsvBtn" class="btn btn-primary" href="#" download>Download as CSV</a>
            </div>
        </div>
        <div id="reportError" style="color: #f87171; margin-bottom: 15px;"></div>
        <div class="summary-cards">
            <div class="summary-card"><h4>Total Footfall</h4><p id="summaryTotal">--</p></div>
            <div class="summary-card"><h4>Busiest Day</h4><p id="summaryDay">--</p></div>
            <div class="summary-card"><h4>Peak Hour (Avg)</h4><p id="summaryHour">--</p></div>
        </div>
        <div><canvas id="reportChart"></canvas></div>
    </div>
</div>

<div id="shutterReportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="shutterReportModalTitle">Shutter Status Report</h2>
            <span class="close-btn" onclick="closeShutterReportModal()">&times;</span>
        </div>
        <div class="report-controls">
            <label for="shutter-report-start">From:</label>
            <input type="date" id="shutter-report-start">
            <label for="shutter-report-end">To:</label>
            <input type="date" id="shutter-report-end">
            <button class="btn btn-primary" onclick="generateShutterReport()">Generate</button>
        </div>
        <div id="shutterReportError" style="color: #f87171; margin-bottom: 15px;"></div>
        <div class="report-section">
            <table id="shutterReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>First Open</th>
                        <th>First Close</th>
                        <th class="hidden">Total Time Open (Hours)</th>
                        <th class="hidden">Total Time Closed (Hours)</th>
                    </tr>
                </thead>
                <tbody id="shutterReportTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- NEW: Modal for displaying shutter event videos -->
<div id="shutterVideoModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="shutterVideoModalTitle">Shutter Event Video</h2>
            <span class="close-btn" onclick="closeShutterVideoModal()">&times;</span>
        </div>
        <div style="padding: 10px 0;">
            <video id="shutterVideoPlayer" width="100%" controls autoplay muted playsinline>
                Your browser does not support the video tag.
            </video>
        </div>
    </div>
</div>


<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-img" src="">
</div>

<script>
    const appConfigs = {{ app_configs|tojson }};
    const dashboardContainer = document.getElementById('dashboard-container');
    const socket = io();
    const reportModal = document.getElementById('reportModal');
    const shutterReportModal = document.getElementById('shutterReportModal');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    let reportChart = null;
    let activeReportChannel = null;
    let activeShutterChannel = null;
    let currentReportData = {};
    let queueCharts = {};
    let roiDrawingState = {};

    const shutterVideoModal = document.getElementById('shutterVideoModal');
    const shutterVideoPlayer = document.getElementById('shutterVideoPlayer');

    function openShutterVideoModal(videoUrl, eventInfo) {
        if (!videoUrl || videoUrl === 'null') {
            alert("No video available for this event.");
            return;
        }
        document.getElementById('shutterVideoModalTitle').textContent = `Video for ${eventInfo}`;
        shutterVideoPlayer.src = videoUrl;
        shutterVideoModal.style.display = 'block';
        shutterVideoPlayer.play().catch(e => console.log("Video autoplay was prevented:", e));
    }

    function closeShutterVideoModal() {
        shutterVideoModal.style.display = 'none';
        shutterVideoPlayer.pause();
        shutterVideoPlayer.src = '';
    }

    function openLightbox(imgSrc) { lightboxImg.src = imgSrc; lightbox.style.display = 'flex'; }
    function closeLightbox() { lightbox.style.display = 'none'; }
    function openReportModal(channelId, channelName) {
        document.getElementById('reportModalTitle').textContent = `Footfall Report for ${channelName}`;
        activeReportChannel = channelId; reportModal.style.display = 'block'; generateReport('7days');
    }
    function closeReportModal() { reportModal.style.display = 'none'; if (reportChart) { reportChart.destroy(); reportChart = null; } }
    function openShutterReportModal(channelId, channelName) {
        document.getElementById('shutterReportModalTitle').textContent = `Shutter Report for ${channelName}`;
        activeShutterChannel = channelId;
        const today = new Date().toISOString().split('T')[0];
        const sevenDaysAgo = new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('shutter-report-start').value = sevenDaysAgo;
        document.getElementById('shutter-report-end').value = today;
        shutterReportModal.style.display = 'block';
        generateShutterReport();
    }
    function closeShutterReportModal() { shutterReportModal.style.display = 'none'; const tableBody = document.getElementById('shutterReportTableBody'); if (tableBody) tableBody.innerHTML = ''; }

    async function loadExistingRoi(appName, channelId) {
        try {
            const response = await fetch(`/api/get_roi?app_name=${appName}&channel_id=${channelId}`);
            const result = await response.json();
            if (result.success && result.roi_points) {
                const canvas = document.getElementById(`stream-box-${appName}-${channelId}`).querySelector('.roi-canvas');
                return {
                    main: result.roi_points.main.map(p => ({ x: p[0] * canvas.width, y: p[1] * canvas.height })),
                    secondary: result.roi_points.secondary.map(p => ({ x: p[0] * canvas.width, y: p[1] * canvas.height }))
                };
            }
        } catch (error) {
            console.log('No existing ROI found, starting fresh');
        }
        return { main: [], secondary: [] };
    }

    async function startRoiEdit(appName, channelId) {
        const streamBox = document.getElementById(`stream-box-${appName}-${channelId}`);
        const canvas = streamBox.querySelector('.roi-canvas');
        const controls = streamBox.querySelector('.roi-controls');
        canvas.style.display = 'block';
        controls.classList.add('active');
        
        // Load existing ROI points
        const existingPoints = await loadExistingRoi(appName, channelId);
        roiDrawingState[channelId] = { points: existingPoints, currentPoly: 'main' };
        redrawRoiCanvas(appName, channelId);
    }

    function cancelRoiEdit(appName, channelId) {
        const streamBox = document.getElementById(`stream-box-${appName}-${channelId}`);
        const canvas = streamBox.querySelector('.roi-canvas');
        const controls = streamBox.querySelector('.roi-controls');
        canvas.style.display = 'none';
        controls.classList.remove('active');
        delete roiDrawingState[channelId];
    }
    
    function resetRoi(appName, channelId) {
        if (roiDrawingState[channelId]) {
            roiDrawingState[channelId].points[roiDrawingState[channelId].currentPoly] = [];
            redrawRoiCanvas(appName, channelId);
        }
    }

    async function saveRoi(appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = document.getElementById(`stream-box-${appName}-${channelId}`).querySelector('.roi-canvas');
        const normalizedPoints = {
            main: state.points.main.map(p => [p.x / canvas.width, p.y / canvas.height]),
            secondary: state.points.secondary.map(p => [p.x / canvas.width, p.y / canvas.height])
        };
        const response = await fetch('/api/set_roi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName, channel_id: channelId, roi_points: normalizedPoints })
        });
        const result = await response.json();
        if (result.success) {
            alert('ROI saved successfully! The stream will update with the new zone.');
            cancelRoiEdit(appName, channelId);
        } else {
            alert(`Error saving ROI: ${result.error}`);
        }
    }

    function handleCanvasClick(event, appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = event.target;
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        state.points[state.currentPoly].push({ x, y });
        redrawRoiCanvas(appName, channelId);
    }

    function redrawRoiCanvas(appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = document.getElementById(`stream-box-${appName}-${channelId}`).querySelector('.roi-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawPolygon(ctx, state.points.main, 'rgba(255, 255, 0, 0.8)', 'rgba(255, 255, 0, 0.2)');
        drawPolygon(ctx, state.points.secondary, 'rgba(0, 255, 255, 0.8)', 'rgba(0, 255, 255, 0.2)');
    }

    function drawPolygon(ctx, points, strokeColor, fillColor) {
        if (points.length === 0) return;
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) { ctx.lineTo(points[i].x, points[i].y); }
        if (points.length > 2) { ctx.closePath(); }
        ctx.strokeStyle = strokeColor; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = fillColor; ctx.fill();
        points.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI); ctx.fillStyle = strokeColor; ctx.fill(); });
    }

    async function generateReport(period) {
        if (!activeReportChannel) return;
        const errorEl = document.getElementById('reportError'); errorEl.textContent = 'Loading report...';
        const response = await fetch(`/generate_report/${activeReportChannel}?period=${period}`);
        const data = await response.json();
        if (data.error) { errorEl.textContent = data.error; if (reportChart) { reportChart.destroy(); reportChart = null; } document.getElementById('summaryTotal').textContent = '--'; document.getElementById('summaryDay').textContent = '--'; document.getElementById('summaryHour').textContent = '--'; return; }
        errorEl.textContent = ''; currentReportData = data; document.getElementById('summaryTotal').textContent = data.summary.total_footfall; document.getElementById('summaryDay').textContent = data.summary.busiest_day; document.getElementById('summaryHour').textContent = data.summary.peak_hour;
        document.getElementById('downloadCsvBtn').href = `/generate_report/${activeReportChannel}?period=${period}&format=csv`; renderChart('bar');
    }
    function renderChart(type) {
        if (!currentReportData.labels) return;
        const ctx = document.getElementById('reportChart').getContext('2d');
        if (reportChart) { reportChart.destroy(); }
        reportChart = new Chart(ctx, { type: type, data: { labels: currentReportData.labels, datasets: [{ label: 'Total Visitors', data: currentReportData.data, backgroundColor: 'rgba(35, 134, 54, 0.5)', borderColor: 'rgba(46, 160, 67, 1)', borderWidth: 2, tension: 0.1 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: 'rgba(201, 209, 217, 0.1)' }, ticks: { color: 'var(--text-secondary)'} }, x: { grid: { color: 'rgba(201, 209, 217, 0.1)' }, ticks: { color: 'var(--text-secondary)'} } }, plugins: { legend: { labels: { color: 'var(--text-primary)' } } } } });
    }
    async function fetchHistory(appName, page = 1, channelId = null, startDate = null, endDate = null) {
        const grid = document.getElementById(`grid-${appName}-${channelId}`);
        const pagination = document.getElementById(`pagination-${appName}-${channelId}`);
        if (!grid) return;
        let url = `/history/${appName}?page=${page}&limit=10`; if (channelId) url += `&channel_id=${channelId}`; if (startDate && endDate) url += `&start_date=${startDate}&end_date=${endDate}`;
        grid.innerHTML = '<p>Loading history...</p>';
        const response = await fetch(url); const data = await response.json();
        if (data.error) { grid.innerHTML = `<p style="color:#f87171;">${data.error}</p>`; return; }
        grid.innerHTML = ''; if (data.detections.length === 0) { grid.innerHTML = '<p>No detections found for the selected criteria.</p>'; }
        else { data.detections.forEach(d => { const item = document.createElement('div'); item.className = 'history-item'; item.innerHTML = `<img src="${d.media_url}" alt="Detection image" onclick="openLightbox('${d.media_url}')"><div class="history-item-info"><p><strong>Message:</strong> ${d.message}</p><p><strong>Time:</strong> ${d.timestamp}</p></div>`; grid.appendChild(item); }); }
        if (pagination) {
            pagination.innerHTML = ''; const totalPages = Math.ceil(data.total / data.limit);
            if (totalPages > 1) {
                const prevBtn = document.createElement('button'); prevBtn.textContent = 'Previous'; prevBtn.disabled = data.page === 1; prevBtn.onclick = () => fetchHistory(appName, data.page - 1, channelId, startDate, endDate); pagination.appendChild(prevBtn);
                const nextBtn = document.createElement('button'); nextBtn.textContent = 'Next'; nextBtn.disabled = data.page >= totalPages; nextBtn.onclick = () => fetchHistory(appName, data.page + 1, channelId, startDate, endDate); pagination.appendChild(nextBtn);
            }
        }
    }
    function applyDateFilter(appName, channelId) { const targetId = `${appName}-${channelId}`; const startDate = document.getElementById(`start-date-${targetId}`).value; const endDate = document.getElementById(`end-date-${targetId}`).value; if (startDate && endDate) { fetchHistory(appName, 1, channelId, startDate, endDate); } else { alert("Please select both a start and end date."); } }
    async function fetchPCReport(channelId, date) {
        const tableBody = document.getElementById(`pc-report-table-${channelId}`); if (!tableBody) return; tableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        const response = await fetch(`/report/${channelId}/${date}`); const data = await response.json();
        tableBody.innerHTML = ''; if (data.error) { tableBody.innerHTML = `<tr><td colspan="3" style="color:#f87171;">${data.error}</td></tr>`; return; }
        for (let hour = 0; hour < 24; hour++) { const hourData = data.hourly_data[hour]; const hourFormatted = new Date(0, 0, 0, hour).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }); const row = `<tr><td>${hourFormatted}</td><td>${hourData.in}</td><td>${hourData.out}</td></tr>`; tableBody.innerHTML += row; }
    }
    function openTab(evt, appName, channelId) {
        const tabContents = document.querySelectorAll(`.tab-content[id^="tab-content-${appName}"]`); tabContents.forEach(tc => tc.classList.remove('active'));
        const tabButtons = evt.currentTarget.parentElement.querySelectorAll('.tab-button'); tabButtons.forEach(tb => tb.classList.remove('active'));
        document.getElementById(`tab-content-${appName}-${channelId}`).classList.add('active'); evt.currentTarget.classList.add('active'); fetchHistory(appName, 1, channelId);
    }
    // Queue monitoring functions removed - simplified to show only current queue count and detection history
    
    async function generateShutterReport() {
        if (!activeShutterChannel) return;
        const startDate = document.getElementById('shutter-report-start').value;
        const endDate = document.getElementById('shutter-report-end').value;
        const errorEl = document.getElementById('shutterReportError');
        const tableBody = document.getElementById('shutterReportTableBody');
        if (!startDate || !endDate) { errorEl.textContent = 'Please select both a start and end date.'; return; }
        errorEl.textContent = 'Loading report...'; tableBody.innerHTML = '';
        const response = await fetch(`/shutter_report/${activeShutterChannel}?start_date=${startDate}&end_date=${endDate}`);
        const data = await response.json();
        if (data.error) { 
            errorEl.textContent = data.error; 
            tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #f87171;">${data.error}</td></tr>`; 
            return;
        }
        if (!data.report_data || data.report_data.length === 0) {
            errorEl.textContent = ''; 
            tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">No data found for the selected period.</td></tr>`; 
            return;
        }
        errorEl.textContent = ''; 
        data.report_data.forEach(row => { 
            const tr = document.createElement('tr');
            
            let openCellHTML;
            if (row.first_open_video_url) {
                openCellHTML = `<a href="#" onclick="event.preventDefault(); openShutterVideoModal('${row.first_open_video_url}', 'First Open on ${row.date}')" style="color: var(--accent-hover); text-decoration: underline;">${row.first_open_time}</a>`;
            } else {
                openCellHTML = row.first_open_time;
            }

            let closeCellHTML;
            if (row.first_close_video_url) {
                closeCellHTML = `<a href="#" onclick="event.preventDefault(); openShutterVideoModal('${row.first_close_video_url}', 'First Close on ${row.date}')" style="color: var(--accent-hover); text-decoration: underline;">${row.first_close_time}</a>`;
            } else {
                closeCellHTML = row.first_close_time;
            }

            tr.innerHTML = `
                <td>${row.date}</td>
                <td>${openCellHTML}</td>
                <td>${closeCellHTML}</td>
                <td class="hidden">${row.total_open_hours}</td>
                <td class="hidden">${row.total_closed_hours}</td>
            `; 
            tableBody.appendChild(tr); 
        });
    }

    function formatDuration(totalSeconds) { if (totalSeconds < 0) totalSeconds = 0; const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); return `${hours}h ${minutes}m`; }
    
    function generateDashboard() {
        const savedOrder = JSON.parse(localStorage.getItem('dashboardLayout'));
        let sortedAppNames = Object.keys(appConfigs).sort((a,b) => { const order = {'PeopleCounter': 1, 'QueueMonitor': 2, 'KitchenCompliance': 3, 'OccupancyMonitor': 4, 'Generic': 5}; return (order[a] || 99) - (order[b] || 99); });
        
        if (savedOrder) {
            sortedAppNames.sort((a, b) => {
                const indexA = savedOrder.indexOf(a);
                const indexB = savedOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }

        for (const appName of sortedAppNames) {
            const config = appConfigs[appName]; if (!config.channels || config.channels.length === 0) continue;
            const section = document.createElement('div'); section.className = 'app-section'; section.dataset.appName = appName;
            let contentHTML = '';
            if (appName === 'PeopleCounter') {
                const channel = config.channels[0]; const today = new Date().toISOString().split('T')[0];
                contentHTML = `<div class="layout-grid"><div class="stream-box"><div class="stream-header">${channel.name}</div><img src="/video_feed/PeopleCounter/${channel.id}" alt="Live feed"><div class="stream-footer">IN: <span id="in-count-${channel.id}">...</span> | OUT: <span id="out-count-${channel.id}">...</span></div></div><div class="report-section"><h3>Daily Footfall</h3><input type="date" value="${today}" onchange="fetchPCReport('${channel.id}', this.value)"><table><thead><tr><th>Hour</th><th>In</th><th>Out</th></tr></thead><tbody id="pc-report-table-${channel.id}"></tbody></table><button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="openReportModal('${channel.id}', '${channel.name}')">Generate Historical Report</button></div></div>`;
                setTimeout(() => fetchPCReport(channel.id, today), 100);
            } else if (appName === 'QueueMonitor') {
                const channel = config.channels[0];
                contentHTML = `<div class="layout-grid">
                    <div class="stream-box" id="stream-box-QueueMonitor-${channel.id}">
                        <div class="stream-header">${channel.name}</div>
                        <img src="/video_feed/QueueMonitor/${channel.id}" alt="Live feed">
                        <canvas class="roi-canvas" style="display:none;" onclick="handleCanvasClick(event, 'QueueMonitor', '${channel.id}')"></canvas>
                        <div class="stream-footer">Current Queue: <span id="queue-count-${channel.id}">...</span></div>
                    </div>
                    <div class="report-section">
                        <h3>Detection History</h3>
                        <div class="filter-controls">
                            <label>From:</label>
                            <input type="date" id="start-date-QueueMonitor-${channel.id}">
                            <label>To:</label>
                            <input type="date" id="end-date-QueueMonitor-${channel.id}">
                            <button class="btn" onclick="applyDateFilter('QueueMonitor', '${channel.id}')">Filter</button>
                        </div>
                        <div class="history-grid" id="grid-QueueMonitor-${channel.id}"></div>
                        <div class="pagination" id="pagination-QueueMonitor-${channel.id}"></div>

                        <div style="margin-top: 16px;">
                            <button class="btn" onclick="startRoiEdit('QueueMonitor', '${channel.id}')">Edit ROI</button>
                            <div class="roi-controls">
                                <button class="btn" onclick="roiDrawingState['${channel.id}'].currentPoly = 'main'">Draw Queue Area (Yellow)</button>
                                <button class="btn" onclick="roiDrawingState['${channel.id}'].currentPoly = 'secondary'">Draw Cashier Area (Cyan)</button>
                                <button class="btn" onclick="resetRoi('QueueMonitor', '${channel.id}')">Reset Current</button>
                                <div style="margin-left:auto; display:flex; gap:10px;">
                                    <button class="btn" onclick="cancelRoiEdit('QueueMonitor', '${channel.id}')">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveRoi('QueueMonitor', '${channel.id}')">Save ROI</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                setTimeout(() => {
                    const canvas = document.getElementById(`stream-box-QueueMonitor-${channel.id}`).querySelector('.roi-canvas');
                    const img = document.getElementById(`stream-box-QueueMonitor-${channel.id}`).querySelector('img');
                    img.onload = () => { canvas.width = img.clientWidth; canvas.height = img.clientHeight; };
                    if(img.complete) { canvas.width = img.clientWidth; canvas.height = img.clientHeight; }
                }, 500);
                setTimeout(() => fetchHistory('QueueMonitor', 1, channel.id), 300);
            } else if (appName === 'KitchenCompliance') {
                const channel = config.channels[0];
                contentHTML = `<div class="layout-grid"><div class="stream-box"><div class="stream-header">${channel.name} - Kitchen Compliance Monitor</div><img src="/video_feed/KitchenCompliance/${channel.id}" alt="Live feed"><div class="stream-footer">Monitoring: Gloves, Apron, Cap, Uniform, Phone</div></div><div class="report-section"><h3>Compliance Violations</h3><div class="summary-cards"><div class="summary-card"><h4>Status</h4><p style="color: #22c55e;">Active Monitoring</p></div><div class="summary-card"><h4>Detection Types</h4><p>5 Violation Types</p></div><div class="summary-card"><h4>Alert Level</h4><p style="color: #f59e0b;">Real-time</p></div></div></div></div><div style="margin-top:20px;"><h3>Violation History</h3><div class="filter-controls"><label>From:</label><input type="date" id="start-date-KitchenCompliance-${channel.id}"><label>To:</label><input type="date" id="end-date-KitchenCompliance-${channel.id}"><button class="btn" onclick="applyDateFilter('KitchenCompliance', '${channel.id}')">Filter</button></div><div class="history-grid" id="grid-KitchenCompliance-${channel.id}"></div><div class="pagination" id="pagination-KitchenCompliance-${channel.id}"></div></div>`;
                setTimeout(() => fetchHistory('KitchenCompliance', 1, channel.id), 100);
            } else if (appName === 'Generic') {
                const channel = config.channels[0];
                contentHTML = `<div class="report-section">
                    <h3>Cash Detection History</h3>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <h4>Status</h4>
                            <p style="color: #22c55e;">Active Monitoring</p>
                        </div>
                        <div class="summary-card">
                            <h4>Detection Types</h4>
                            <p>7 Object Classes</p>
                        </div>
                        <div class="summary-card">
                            <h4>Format</h4>
                            <p style="color: #3b82f6;">Animated GIF</p>
                        </div>
                    </div>
                    <div class="filter-controls">
                        <label>From:</label>
                        <input type="date" id="start-date-Generic-${channel.id}">
                        <label>To:</label>
                        <input type="date" id="end-date-Generic-${channel.id}">
                        <button class="btn" onclick="applyDateFilter('Generic', '${channel.id}')">Filter</button>
                    </div>
                    <div class="history-grid" id="grid-Generic-${channel.id}"></div>
                    <div class="pagination" id="pagination-Generic-${channel.id}"></div>
                </div>`;
                setTimeout(() => fetchHistory('Generic', 1, channel.id), 100);
            } else if (appName === 'OccupancyMonitor') {
                const channel = config.channels[0];
                contentHTML = `<div class="layout-grid">
                    <div class="stream-box">
                        <div class="stream-header">${channel.name} - Occupancy Monitor</div>
                        <img src="/video_feed/OccupancyMonitor/${channel.id}" alt="Live feed">
                        <div class="stream-footer">Live Count: <span id="live-count-${channel.id}">0</span> | Required: <span id="required-count-${channel.id}">0</span></div>
                    </div>
                    <div class="report-section">
                        <h3>Occupancy Management</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>Current Status</h4>
                                <p id="occupancy-status-${channel.id}" style="color: #22c55e;">Active Monitoring</p>
                            </div>
                            <div class="summary-card">
                                <h4>Time Slot</h4>
                                <p id="time-slot-${channel.id}">No Schedule</p>
                            </div>
                            <div class="summary-card">
                                <h4>Device</h4>
                                <p id="device-info-${channel.id}">CUDA/CPU</p>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn" onclick="openScheduleModal('${channel.id}', '${channel.name}')">Manage Schedule</button>
                            <button class="btn" onclick="viewOccupancyLogs('${channel.id}')">View Logs</button>
                        </div>
                    </div>
                </div>`;
                setTimeout(() => {
                    // Initialize occupancy monitoring
                    initializeOccupancyMonitor(channel.id);
                }, 100);
            } else {
                let tabsNav = '<div class="tab-nav">'; let tabsContent = '';
                config.channels.forEach((channel, index) => {
                    const activeClass = index === 0 ? 'active' : ''; tabsNav += `<button class="tab-button ${activeClass}" onclick="openTab(event, '${appName}', '${channel.id}')">${channel.name}</button>`;
                    const targetId = `${appName}-${channel.id}`; let filterControls = `<div class="filter-controls"><label>From:</label><input type="date" id="start-date-${targetId}"><label>To:</label><input type="date" id="end-date-${targetId}"><button class="btn" onclick="applyDateFilter('${appName}', '${channel.id}')">Filter</button></div>`;
                    tabsContent += `<div id="tab-content-${targetId}" class="tab-content ${activeClass}">${filterControls}<div class="history-grid" id="grid-${appName}-${channel.id}"></div><div class="pagination" id="pagination-${appName}-${channel.id}"></div></div>`;
                });
                tabsNav += '</div>'; contentHTML = tabsNav + tabsContent; if(config.channels.length > 0) { setTimeout(() => fetchHistory(appName, 1, config.channels[0].id), 100); }
            }
            const onlineStatus = `<span class="status"><span class="online-dot"></span>${config.online_count} / ${config.channels.length} Channels Online</span>`; section.innerHTML = `<div class="app-header"><h2>${appName}</h2> ${onlineStatus}</div><div class="app-content">${contentHTML}</div>`; dashboardContainer.appendChild(section);
        }
        
        new Sortable(dashboardContainer, {
            animation: 150, handle: '.app-header',
            onEnd: function (evt) {
                const order = Array.from(dashboardContainer.children).map(el => el.dataset.appName);
                localStorage.setItem('dashboardLayout', JSON.stringify(order));
            },
        });
    }
    socket.on('count_update', data => { const inCount = document.getElementById(`in-count-${data.channel_id}`); const outCount = document.getElementById(`out-count-${data.channel_id}`); if (inCount) inCount.textContent = data.in_count; if (outCount) outCount.textContent = data.out_count; });
    socket.on('queue_update', data => { 
        const queueCount = document.getElementById(`queue-count-${data.channel_id}`); 
        const currentQueue = document.getElementById(`current-queue-${data.channel_id}`);
        if (queueCount) queueCount.textContent = data.count; 
        if (currentQueue) currentQueue.textContent = data.count;
    });
    socket.on('shutter_update', data => {
        const { channel_id, last_status, last_status_time, first_open_time, first_close_time, total_open_duration_seconds, total_closed_duration_seconds } = data;
        document.getElementById(`shutter-status-${channel_id}`).textContent = last_status.toUpperCase();
        document.getElementById(`shutter-status-time-${channel_id}`).textContent = `Since ${new Date(last_status_time).toLocaleTimeString()}`;
        document.getElementById(`shutter-first-open-${channel_id}`).textContent = first_open_time ? new Date(first_open_time).toLocaleTimeString() : 'Not yet opened';
        document.getElementById(`shutter-first-close-${channel_id}`).textContent = first_close_time ? new Date(first_close_time).toLocaleTimeString() : 'Not yet closed';
        document.getElementById(`shutter-total-open-${channel_id}`).textContent = formatDuration(total_open_duration_seconds);
        document.getElementById(`shutter-total-closed-${channel_id}`).textContent = formatDuration(total_closed_duration_seconds);
    });
    socket.on('new_detection', data => { const { app_name, channel_id } = data; const activeTab = document.querySelector(`.tab-content.active`); if (activeTab && activeTab.id === `tab-content-${app_name}-${channel_id}`) { fetchHistory(app_name, 1, channel_id); } if (app_name === 'QueueMonitor' && document.getElementById(`grid-QueueMonitor-${channel_id}`)) { fetchHistory(app_name, 1, channel_id); } });
    socket.on('security_violation', data => {
        const tbody = document.getElementById(`security-tbody-${data.channel_id}`);
        if (tbody) {
            const placeholder = tbody.querySelector('td[colspan="3"]');
            if (placeholder) placeholder.parentElement.remove();
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td>${data.timestamp}</td><td>${data.message}</td><td>${data.details}</td>`;
            tbody.prepend(newRow);
            while (tbody.rows.length > 15) { tbody.deleteRow(-1); }
        }
    });

    // Occupancy Monitor Functions
    function initializeOccupancyMonitor(channelId) {
        console.log(`Initializing Occupancy Monitor for channel ${channelId}`);
        // This will be called when the OccupancyMonitor section is loaded
    }

    function openScheduleModal(channelId, channelName) {
        // Create and show schedule management modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="width: 90%; max-width: 1000px;">
                <div class="modal-header">
                    <h3>Manage Schedule - ${channelName}</h3>
                    <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>üìÅ Upload Schedule File</h4>
                        <p style="margin: 10px 0; color: #666;">Upload a CSV or Excel file to set the occupancy schedule automatically.</p>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="schedule-file-${channelId}" accept=".csv,.xlsx,.xls" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 200px;">
                            <button class="btn btn-primary" onclick="uploadSchedule('${channelId}')">Upload & Apply</button>
                            <a href="/api/occupancy/schedule/template" class="btn" style="background: #28a745; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px;">Download Template</a>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <strong>Supported formats:</strong> CSV, Excel (.xlsx, .xls)<br>
                            <strong>Template includes:</strong> Sample schedule with business hours (8 AM - 8 PM)
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>üìã Current Schedule (Manual Edit)</h4>
                        <div id="schedule-grid-${channelId}" style="max-height: 400px; overflow-y: auto;">
                            <p>Loading schedule...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="saveSchedule('${channelId}')">Save Manual Changes</button>
                        <button class="btn" onclick="this.parentElement.parentElement.parentElement.remove()" style="margin-left: 10px;">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        loadSchedule(channelId);
    }

    function loadSchedule(channelId) {
        // Load current schedule from server
        fetch(`/api/occupancy/schedule/${channelId}`)
            .then(response => response.json())
            .then(data => {
                displaySchedule(channelId, data);
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                document.getElementById(`schedule-grid-${channelId}`).innerHTML = '<p>Error loading schedule</p>';
            });
    }

    function displaySchedule(channelId, schedule) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
        
        let html = '<table class="schedule-table"><thead><tr><th>Day</th>';
        hours.forEach(hour => {
            html += `<th>${hour}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        days.forEach(day => {
            html += `<tr><td><strong>${day}</strong></td>`;
            hours.forEach(hour => {
                const value = schedule[hour] && schedule[hour][day] ? schedule[hour][day] : '';
                html += `<td><input type="number" min="0" max="100" value="${value}" 
                         id="schedule-${channelId}-${day}-${hour}" placeholder="0" style="width: 50px;"></td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        document.getElementById(`schedule-grid-${channelId}`).innerHTML = html;
    }

    function saveSchedule(channelId) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
        
        const schedule = {};
        hours.forEach(hour => {
            schedule[hour] = {};
            days.forEach(day => {
                const input = document.getElementById(`schedule-${channelId}-${day}-${hour}`);
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    schedule[hour][day] = value;
                }
            });
        });

        fetch(`/api/occupancy/schedule/${channelId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(schedule)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Schedule saved successfully!');
                document.querySelector('.modal').remove();
            } else {
                alert('Error saving schedule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving schedule:', error);
            alert('Error saving schedule');
        });
    }

    function viewOccupancyLogs(channelId) {
        // Open occupancy logs in a new window or modal
        window.open(`/occupancy-logs/${channelId}`, '_blank');
    }

    function uploadSchedule(channelId) {
        const fileInput = document.getElementById(`schedule-file-${channelId}`);
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file to upload');
            return;
        }
        
        // Validate file type
        const allowedTypes = ['.csv', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExtension)) {
            alert('Please select a CSV or Excel file (.csv, .xlsx, .xls)');
            return;
        }
        
        // Show loading state
        const uploadBtn = fileInput.nextElementSibling;
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = 'Uploading...';
        uploadBtn.disabled = true;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/api/occupancy/schedule/upload/${channelId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ ${data.message}`);
                // Reload the schedule display
                loadSchedule(channelId);
            } else {
                alert(`‚ùå Error uploading schedule: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error uploading schedule. Please try again.');
        })
        .finally(() => {
            // Reset button state
            uploadBtn.textContent = originalText;
            uploadBtn.disabled = false;
            // Clear file input
            fileInput.value = '';
        });
    }

    // Socket.IO handlers for OccupancyMonitor
    socket.on('occupancy_update', data => {
        const liveCountEl = document.getElementById(`live-count-${data.channel_id}`);
        const requiredCountEl = document.getElementById(`required-count-${data.channel_id}`);
        const statusEl = document.getElementById(`occupancy-status-${data.channel_id}`);
        const timeSlotEl = document.getElementById(`time-slot-${data.channel_id}`);
        
        if (liveCountEl) liveCountEl.textContent = data.live_count;
        if (requiredCountEl) requiredCountEl.textContent = data.required_count;
        if (timeSlotEl) timeSlotEl.textContent = data.time_slot;
        
        if (statusEl) {
            statusEl.textContent = data.status;
            switch(data.status) {
                case 'OK':
                    statusEl.style.color = '#22c55e';
                    break;
                case 'BELOW_REQUIREMENT':
                    statusEl.style.color = '#ef4444';
                    break;
                case 'NO_SCHEDULE':
                    statusEl.style.color = '#6b7280';
                    break;
                case 'PAUSED':
                    statusEl.style.color = '#f59e0b';
                    break;
            }
        }
    });

    generateDashboard();
</script>
</body>
</html>

